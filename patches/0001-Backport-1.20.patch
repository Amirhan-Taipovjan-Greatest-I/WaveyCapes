From 220be7f1d41668e4afc94825ddea7552207f51fc Mon Sep 17 00:00:00 2001
From: tr7zw <tr7zw@live.de>
Date: Sat, 30 Sep 2023 21:35:36 +0200
Subject: [PATCH] Backport 1.20

---
 .../java/dev/tr7zw/waveycapes/VanillaCapeRenderer.java     | 2 +-
 .../waveycapes/renderlayers/CustomCapeRenderLayer.java     | 7 ++++---
 .../tr7zw/waveycapes/support/MinecraftCapesSupport.java    | 4 ++--
 WCFabric/src/main/resources/fabric.mod.json                | 2 +-
 .../tr7zw/waveycapes/support/MinecraftCapesSupport.java    | 4 ++--
 WCForge/src/main/resources/META-INF/mods.toml              | 2 +-
 gradle-compose.yml                                         | 6 +++---
 7 files changed, 14 insertions(+), 13 deletions(-)

diff --git a/Shared/src/main/java/dev/tr7zw/waveycapes/VanillaCapeRenderer.java b/Shared/src/main/java/dev/tr7zw/waveycapes/VanillaCapeRenderer.java
index 574dae2..19697bb 100644
--- a/Shared/src/main/java/dev/tr7zw/waveycapes/VanillaCapeRenderer.java
+++ b/Shared/src/main/java/dev/tr7zw/waveycapes/VanillaCapeRenderer.java
@@ -21,7 +21,7 @@ public class VanillaCapeRenderer implements CapeRenderer {
 
     @Override
     public VertexConsumer getVertexConsumer(MultiBufferSource multiBufferSource, AbstractClientPlayer player) {
-        return multiBufferSource.getBuffer(RenderType.entityCutout(player.getSkin().capeTexture()));
+        return multiBufferSource.getBuffer(RenderType.entityCutout(player.getCloakTextureLocation()));
     }
 
     @Override
diff --git a/Shared/src/main/java/dev/tr7zw/waveycapes/renderlayers/CustomCapeRenderLayer.java b/Shared/src/main/java/dev/tr7zw/waveycapes/renderlayers/CustomCapeRenderLayer.java
index 9a47a49..fa8c493 100644
--- a/Shared/src/main/java/dev/tr7zw/waveycapes/renderlayers/CustomCapeRenderLayer.java
+++ b/Shared/src/main/java/dev/tr7zw/waveycapes/renderlayers/CustomCapeRenderLayer.java
@@ -484,12 +484,13 @@ public class CustomCapeRenderLayer extends RenderLayer<AbstractClientPlayer, Pla
                 return support.getRenderer();
             }
         }
-        if (abstractClientPlayer.getSkin().capeTexture() == null || abstractClientPlayer.isInvisible()
-                || !abstractClientPlayer.isModelPartShown(PlayerModelPart.CAPE)) {
+        if (!abstractClientPlayer.isCapeLoaded() || abstractClientPlayer.isInvisible()
+                || !abstractClientPlayer.isModelPartShown(PlayerModelPart.CAPE)
+                || abstractClientPlayer.getCloakTextureLocation() == null) {
             return null;
         } else {
             vanillaCape.vertexConsumer = multiBufferSource
-            .getBuffer(RenderType.entityCutout(abstractClientPlayer.getSkin().capeTexture()));
+            .getBuffer(RenderType.entityCutout(abstractClientPlayer.getCloakTextureLocation()));
             return vanillaCape;
         }
     }
diff --git a/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java b/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java
index de4e7fb..7c79f62 100644
--- a/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java
+++ b/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java
@@ -38,7 +38,7 @@ public class MinecraftCapesSupport implements ModSupport {
             if(MinecraftCapesConfig.isCapeVisible() && playerHandler.getCapeLocation() != null) {
                 vertexConsumer = ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(playerHandler.getCapeLocation()), false, playerHandler.getHasCapeGlint());
             } else {
-                vertexConsumer = ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getSkin().capeTexture()), false, false);
+                vertexConsumer = ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getCloakTextureLocation()), false, false);
             }
             model.render(poseStack, vertexConsumer, light, OverlayTexture.NO_OVERLAY);
         }
@@ -49,7 +49,7 @@ public class MinecraftCapesSupport implements ModSupport {
             if(MinecraftCapesConfig.isCapeVisible() && playerHandler.getCapeLocation() != null) {
                 return ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(playerHandler.getCapeLocation()), false, playerHandler.getHasCapeGlint());
             } else {
-                return ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getSkin().capeTexture()), false, false);
+                return ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getCloakTextureLocation()), false, false);
             }
         }
         
diff --git a/WCFabric/src/main/resources/fabric.mod.json b/WCFabric/src/main/resources/fabric.mod.json
index 2c1649a..d7b7f29 100644
--- a/WCFabric/src/main/resources/fabric.mod.json
+++ b/WCFabric/src/main/resources/fabric.mod.json
@@ -30,6 +30,6 @@
   ],
 
   "depends": {
-    "minecraft": ">=1.20.2"
+    "minecraft": ">=1.20"
   }
 }
diff --git a/WCForge/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java b/WCForge/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java
index c125386..90c2d1d 100644
--- a/WCForge/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java
+++ b/WCForge/src/main/java/dev/tr7zw/waveycapes/support/MinecraftCapesSupport.java
@@ -38,7 +38,7 @@ public class MinecraftCapesSupport implements ModSupport {
             if(MinecraftCapesConfig.isCapeVisible() && playerHandler.getCapeLocation() != null) {
                 vertexConsumer = ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(playerHandler.getCapeLocation()), false, playerHandler.getHasCapeGlint());
             } else {
-                vertexConsumer = ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getSkin().capeTexture()), false, false);
+                vertexConsumer = ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getCloakTextureLocation()), false, false);
             }
             model.render(poseStack, vertexConsumer, light, OverlayTexture.NO_OVERLAY);
         }
@@ -49,7 +49,7 @@ public class MinecraftCapesSupport implements ModSupport {
             if(MinecraftCapesConfig.isCapeVisible() && playerHandler.getCapeLocation() != null) {
                 return ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(playerHandler.getCapeLocation()), false, playerHandler.getHasCapeGlint());
             } else {
-                return ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getSkin().capeTexture()), false, false);
+                return ItemRenderer.getArmorFoilBuffer(multiBufferSource, RenderType.armorCutoutNoCull(player.getCloakTextureLocation()), false, false);
             }
         }
         
diff --git a/WCForge/src/main/resources/META-INF/mods.toml b/WCForge/src/main/resources/META-INF/mods.toml
index a26c76b..9cc693f 100644
--- a/WCForge/src/main/resources/META-INF/mods.toml
+++ b/WCForge/src/main/resources/META-INF/mods.toml
@@ -17,6 +17,6 @@ The cape shouldn't be a static slab
 [[dependencies.waveycapes]]
     modId="minecraft"
     mandatory=true
-    versionRange="[1.20.2,)"
+    versionRange="[1.20,)"
     ordering="NONE"
     side="BOTH"
\ No newline at end of file
diff --git a/gradle-compose.yml b/gradle-compose.yml
index 2289ef2..e180133 100644
--- a/gradle-compose.yml
+++ b/gradle-compose.yml
@@ -1,5 +1,5 @@
 version: '0.0.2'
-source: "https://github.com/tr7zw/ModComposeTemplate/tree/1.20.2"
+source: "https://github.com/tr7zw/ModComposeTemplate/tree/1.20"
 replacements:
   name: "WaveyCapes"
   id: "waveycapes"
@@ -22,11 +22,11 @@ subProjects:
       dependencies: '
       modCompileOnly "curse.maven:morebanners-515000:3820969"
       
-      modCompileOnly "curse.maven:minecraftcapes-mod-359836:4763650"
+      modCompileOnly "curse.maven:minecraftcapes-mod-359836:4562672"
       '
   WCForge:
     template: "Forge"
     replacements:
       dependencies: '
-      modCompileOnly "curse.maven:minecraftcapes-mod-359836:4562670"
+      modImplementation "curse.maven:minecraftcapes-mod-359836:4562670"
       '
\ No newline at end of file
-- 
2.32.0.windows.2

