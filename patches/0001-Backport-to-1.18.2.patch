From d106ee99cc3fae8a5f1119a3047940b97278c41a Mon Sep 17 00:00:00 2001
From: tr7zw <tr7zw@live.de>
Date: Sat, 28 Jan 2023 02:48:22 +0100
Subject: [PATCH] Backport to 1.18.2

---
 .../java/dev/tr7zw/waveycapes/WaveyCapesBase.java    |  6 +++---
 .../support/MoreBannerFeaturesSupport.java           | 12 +++++++++++-
 WCFabric/src/main/resources/fabric.mod.json          |  2 +-
 .../java/dev/tr7zw/waveycapes/WaveyCapesMod.java     |  4 ++--
 WCForge/src/main/resources/META-INF/mods.toml        |  2 +-
 gradle-compose.yml                                   |  8 ++++----
 6 files changed, 22 insertions(+), 12 deletions(-)

diff --git a/Shared/src/main/java/dev/tr7zw/waveycapes/WaveyCapesBase.java b/Shared/src/main/java/dev/tr7zw/waveycapes/WaveyCapesBase.java
index c56aa29..597ad68 100644
--- a/Shared/src/main/java/dev/tr7zw/waveycapes/WaveyCapesBase.java
+++ b/Shared/src/main/java/dev/tr7zw/waveycapes/WaveyCapesBase.java
@@ -22,7 +22,7 @@ import dev.tr7zw.config.CustomConfigScreen;
 import dev.tr7zw.waveycapes.config.Config;
 import dev.tr7zw.waveycapes.config.ConfigUpgrader;
 import net.minecraft.client.Minecraft;
-import net.minecraft.client.OptionInstance;
+import net.minecraft.client.Option;
 import net.minecraft.client.gui.screens.Screen;
 import net.minecraft.client.renderer.MultiBufferSource;
 import net.minecraft.client.renderer.entity.EntityRenderDispatcher;
@@ -77,7 +77,7 @@ public abstract class WaveyCapesBase {
             
             @Override
             public void initialize() {
-                List<OptionInstance<?>> options = new ArrayList<>();
+                List<Option> options = new ArrayList<>();
                 options.add(getEnumOption("text.wc.setting.capestyle", CapeStyle.class, () -> config.capeStyle, (v) -> config.capeStyle = v));
                 options.add(getEnumOption("text.wc.setting.windmode", WindMode.class, () -> config.windMode, (v) -> config.windMode = v));
                 options.add(getEnumOption("text.wc.setting.capemovement", CapeMovement.class, () -> config.capeMovement, (v) -> config.capeMovement = v));
@@ -86,7 +86,7 @@ public abstract class WaveyCapesBase {
                 options.add(getIntOption("text.wc.setting.heightMultiplier", 4, 16, () -> config.heightMultiplier, (v) -> config.heightMultiplier = v));
                 //options.add(getIntOption("text.wc.setting.maxBend", 1, 20, () -> config.maxBend, (v) -> config.maxBend = v));
 
-                getOptions().addSmall(options.toArray(new OptionInstance[0]));
+                getOptions().addSmall(options.toArray(new Option[0]));
 
             }
 
diff --git a/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MoreBannerFeaturesSupport.java b/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MoreBannerFeaturesSupport.java
index 3b37df5..b312d5b 100644
--- a/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MoreBannerFeaturesSupport.java
+++ b/WCFabric/src/main/java/dev/tr7zw/waveycapes/support/MoreBannerFeaturesSupport.java
@@ -1,9 +1,11 @@
 package dev.tr7zw.waveycapes.support;
 
 import java.util.HashMap;
+import java.util.List;
 import java.util.stream.Collectors;
 
 import com.mojang.blaze3d.vertex.PoseStack;
+import com.mojang.datafixers.util.Pair;
 
 import de.kxmischesdomi.morebannerfeatures.core.accessor.Bannerable;
 import de.kxmischesdomi.morebannerfeatures.renderer.BannerCapeFeatureRenderer;
@@ -14,8 +16,13 @@ import net.minecraft.client.model.geom.builders.CubeDeformation;
 import net.minecraft.client.model.geom.builders.CubeListBuilder;
 import net.minecraft.client.player.AbstractClientPlayer;
 import net.minecraft.client.renderer.MultiBufferSource;
+import net.minecraft.client.renderer.texture.OverlayTexture;
+import net.minecraft.client.resources.model.ModelBakery;
 import net.minecraft.world.item.BannerItem;
+import net.minecraft.world.item.DyeColor;
 import net.minecraft.world.item.ItemStack;
+import net.minecraft.world.level.block.entity.BannerBlockEntity;
+import net.minecraft.world.level.block.entity.BannerPattern;
 
 public class MoreBannerFeaturesSupport implements ModSupport {
 
@@ -48,8 +55,11 @@ public class MoreBannerFeaturesSupport implements ModSupport {
         public void render(AbstractClientPlayer player, int part, ModelPart model, PoseStack poseStack,
                 MultiBufferSource multiBufferSource, int light, int overlay) {
             ItemStack bannerItem = ((Bannerable) player).getBannerItem();
+            List<Pair<BannerPattern, DyeColor>> patterns = BannerBlockEntity.createPatterns(
+                    ((BannerItem) bannerItem.getItem()).getColor(), BannerBlockEntity.getItemPatterns(bannerItem));
 
-            RendererUtils.renderCanvasFromItem(bannerItem, poseStack, multiBufferSource, light, overlay, model);
+            RendererUtils.renderCanvas(poseStack, multiBufferSource, light, OverlayTexture.NO_OVERLAY, customCape[part],
+                    ModelBakery.BANNER_BASE, true, patterns);
         }
         
         @Override
diff --git a/WCFabric/src/main/resources/fabric.mod.json b/WCFabric/src/main/resources/fabric.mod.json
index cde5c7c..f285cdb 100644
--- a/WCFabric/src/main/resources/fabric.mod.json
+++ b/WCFabric/src/main/resources/fabric.mod.json
@@ -30,7 +30,7 @@
   ],
 
   "depends": {
-    "minecraft": ">1.19.0 <=1.19.2",
+    "minecraft": "1.18.x",
     "java": ">=16"
   }
 }
diff --git a/WCForge/src/main/java/dev/tr7zw/waveycapes/WaveyCapesMod.java b/WCForge/src/main/java/dev/tr7zw/waveycapes/WaveyCapesMod.java
index 7cbd2d9..0d62633 100644
--- a/WCForge/src/main/java/dev/tr7zw/waveycapes/WaveyCapesMod.java
+++ b/WCForge/src/main/java/dev/tr7zw/waveycapes/WaveyCapesMod.java
@@ -2,7 +2,7 @@ package dev.tr7zw.waveycapes;
 
 import dev.tr7zw.waveycapes.support.MinecraftCapesSupport;
 import dev.tr7zw.waveycapes.support.SupportManager;
-import net.minecraftforge.client.ConfigScreenHandler.ConfigScreenFactory;
+import net.minecraftforge.client.ConfigGuiHandler.ConfigGuiFactory;
 import net.minecraftforge.fml.IExtensionPoint;
 import net.minecraftforge.fml.ModLoadingContext;
 import net.minecraftforge.fml.common.Mod;
@@ -18,7 +18,7 @@ public class WaveyCapesMod extends WaveyCapesBase {
             return;
         }
 	    init();
-        ModLoadingContext.get().registerExtensionPoint(ConfigScreenFactory.class, () -> new ConfigScreenFactory((mc, screen) -> {
+        ModLoadingContext.get().registerExtensionPoint(ConfigGuiFactory.class, () -> new ConfigGuiFactory((mc, screen) -> {
             return createConfigScreen(screen);
         }));
 		ModLoadingContext.get().registerExtensionPoint(IExtensionPoint.DisplayTest.class,
diff --git a/WCForge/src/main/resources/META-INF/mods.toml b/WCForge/src/main/resources/META-INF/mods.toml
index a8c0e15..f80eb56 100644
--- a/WCForge/src/main/resources/META-INF/mods.toml
+++ b/WCForge/src/main/resources/META-INF/mods.toml
@@ -17,6 +17,6 @@ The cape shouldn't be a static slab
 [[dependencies.waveycapes]]
     modId="minecraft"
     mandatory=true
-    versionRange="[1.19,)"
+    versionRange="[1.18.2,)"
     ordering="NONE"
     side="BOTH"
\ No newline at end of file
diff --git a/gradle-compose.yml b/gradle-compose.yml
index 7f0be62..1fe2cbb 100644
--- a/gradle-compose.yml
+++ b/gradle-compose.yml
@@ -1,5 +1,5 @@
 version: '0.0.2'
-source: "https://github.com/tr7zw/ModComposeTemplate/tree/1.19.2"
+source: "https://github.com/tr7zw/ModComposeTemplate/tree/1.18.2"
 replacements:
   name: "WaveyCapes"
   id: "waveycapes"
@@ -20,13 +20,13 @@ subProjects:
     template: "Fabric"
     replacements:
       dependencies: '
-      modCompileOnly "curse.maven:morebanners-515000:3820969"
+      modCompileOnly "curse.maven:morebanners-515000:3453480"
       
-      modCompileOnly "curse.maven:minecraftcapes-mod-359836:3821433"
+      modCompileOnly "curse.maven:minecraftcapes-mod-359836:3409502"
       '
   WCForge:
     template: "Forge"
     replacements:
       dependencies: '
-      modImplementation "curse.maven:minecraftcapes-mod-359836:3821435"
+      modImplementation "curse.maven:minecraftcapes-mod-359836:3542122"
       '
\ No newline at end of file
-- 
2.32.0.windows.2

